{% extends 'base.html' %}
{% block content %}
<style>
/* Custom styling for dashboard */
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 20px 20px;
}

.dashboard-header h1 {
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.stats-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stats-card .card-body {
    padding: 1.5rem;
}

.stats-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    opacity: 0.9;
}

.expiry-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    margin-bottom: 2rem;
    transition: all 0.3s ease;
}

.expiry-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.expiry-card .card-header {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    border: none;
    border-radius: 15px 15px 0 0;
    padding: 1rem 1.5rem;
}

.expiry-card .card-body {
    padding: 0;
}

.badge-sm {
    font-size: 0.7em;
    padding: 0.4em 0.8em;
    border-radius: 20px;
    font-weight: 600;
}

.table-sm th, .table-sm td {
    padding: 0.75rem 1rem;
    font-size: 0.9em;
    border: none;
}

.table-sm thead th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.table-sm tbody tr {
    border-bottom: 1px solid #f1f3f4;
}

.table-sm tbody tr:hover {
    background-color: #f8f9fa;
}

.pagination-container {
    background: #f8f9fa;
    padding: 1rem 1.5rem;
    border-radius: 0 0 15px 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 0.5rem;
}

.pagination-controls .btn {
    min-width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.pagination-controls .btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.service-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
    height: 100%;
}

.service-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.service-card .card-body {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.service-card .btn {
    margin-top: auto;
    border-radius: 25px;
    font-weight: 600;
    padding: 0.5rem 1.5rem;
    transition: all 0.3s ease;
}

.service-card .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.text-bg-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
.text-bg-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important; }
.text-bg-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; }
.text-bg-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important; }
.text-bg-danger { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important; }

.alert-success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: none;
    border-radius: 10px;
    color: #155724;
}

.alert-danger {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border: none;
    border-radius: 10px;
    color: #721c24;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .dashboard-header {
        padding: 1.5rem 0;
        margin-bottom: 1.5rem;
    }
    
    .stats-number {
        font-size: 2rem;
    }
    
    .service-card .card-body {
        padding: 1rem;
    }
}
</style>

<div class="dashboard-header">
    <div class="container">
        <h1>üìä Dashboard VPS Manager</h1>
        <p class="mb-0 opacity-75">T·ªïng quan h·ªá th·ªëng qu·∫£n l√Ω VPS v√† t√†i kho·∫£n</p>
    </div>
</div>

<!-- Th√¥ng b√°o l·ªói access denied -->
<div id="access-denied-alert" class="alert alert-danger" style="display:none;">
    <h5>üö´ Truy c·∫≠p b·ªã t·ª´ ch·ªëi</h5>
    <p>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n l√Ω user. Ch·ªâ admin m·ªõi c√≥ th·ªÉ truy c·∫≠p t√≠nh nƒÉng n√†y.</p>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="card stats-card text-bg-primary">
      <div class="card-body text-center">
        <h6 class="stats-title">üñ•Ô∏è S·ªë l∆∞·ª£ng VPS</h6>
        <p class="stats-number" id="vps-count">0</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stats-card text-bg-success">
      <div class="card-body text-center">
        <h6 class="stats-title">üë§ S·ªë l∆∞·ª£ng t√†i kho·∫£n</h6>
        <p class="stats-number" id="account-count">0</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stats-card text-bg-warning">
      <div class="card-body text-center">
        <h6 class="stats-title">‚ö†Ô∏è C·∫£nh b√°o h·∫øt h·∫°n</h6>
        <p class="stats-number" id="expiry-count">0</p>
      </div>
    </div>
  </div>
</div>

<!-- Th√™m section hi·ªÉn th·ªã chi ti·∫øt c·∫£nh b√°o h·∫øt h·∫°n -->
<div class="row justify-content-center">
  <div class="col-lg-10 col-xl-9">
    <div class="card expiry-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">üìÖ Chi ti·∫øt c·∫£nh b√°o h·∫øt h·∫°n</h6>
        <span class="badge bg-light text-dark" id="expiry-summary">0 items</span>
      </div>
      <div class="card-body">
        <div id="expiry-details">
          <!-- Chi ti·∫øt c·∫£nh b√°o s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
        </div>
        
        <!-- Ph√¢n trang -->
        <div id="pagination-container" class="pagination-container" style="display: none !important;">
          <div class="pagination-controls">
            <button id="prev-page" class="btn btn-sm btn-outline-secondary me-1" disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="page-numbers" class="mx-2"></span>
            <button id="next-page" class="btn btn-sm btn-outline-secondary ms-1" disabled>
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          <div class="pagination-info">
            <small class="text-muted" id="pagination-info">Hi·ªÉn th·ªã 0-0 c·ªßa 0 items</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-3 col-md-6">
    <div class="card service-card text-bg-info">
      <div class="card-body">
        <h5 class="card-title">üöÄ BitLaunch</h5>
        <p class="card-text">Qu·∫£n l√Ω t√†i kho·∫£n, s·ªë d∆∞, l·ªãch s·ª≠ giao d·ªãch, n·∫°p ti·ªÅn, server, SSH key...</p>
        <a href="/bitlaunch" class="btn btn-outline-light">S·ª≠ d·ª•ng API</a>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card service-card text-bg-success">
      <div class="card-body">
        <h5 class="card-title">üåê ZingProxy</h5>
        <p class="card-text">Qu·∫£n l√Ω t√†i kho·∫£n, s·ªë d∆∞, proxy, tr·∫°ng th√°i, ng√†y h·∫øt h·∫°n qua API.</p>
        <a href="/zingproxy" class="btn btn-outline-light">S·ª≠ d·ª•ng API</a>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card service-card text-bg-warning">
      <div class="card-body">
        <h5 class="card-title">‚òÅÔ∏è CloudFly</h5>
        <p class="card-text">Qu·∫£n l√Ω VPS v√† t√†i kho·∫£n CloudFly th√¥ng qua API.</p>
        <a href="/cloudfly" class="btn btn-outline-light">S·ª≠ d·ª•ng API</a>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card service-card text-bg-danger">
      <div class="card-body">
        <h5 class="card-title">üí¨ Rocket Chat</h5>
        <p class="card-text">C·∫•u h√¨nh v√† g·ª≠i th√¥ng b√°o t·ª± ƒë·ªông v·ªÅ t√†i kho·∫£n s·∫Øp h·∫øt h·∫°n, balance th·∫•p.</p>
        <a href="/rocket-chat" class="btn btn-outline-light">C·∫•u h√¨nh</a>
      </div>
    </div>
  </div>
</div>

<script>
// Ki·ªÉm tra URL parameters ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o l·ªói
function checkUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    
    if (error === 'access_denied') {
        document.getElementById('access-denied-alert').style.display = 'block';
        // X√≥a parameter kh·ªèi URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

// H√†m t√≠nh s·ªë ng√†y c√≤n l·∫°i
function calculateDaysUntilExpiry(expiryStr) {
    if (!expiryStr) return null;
    try {
        const expiryDate = new Date(expiryStr);
        const today = new Date();
        const diffTime = expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    } catch {
        return null;
    }
}

// H√†m format message cho s·ªë ng√†y
function formatDaysMessage(days) {
    if (days > 0) {
        return `‚è∞ C√≤n l·∫°i: ${days} ng√†y`;
    } else if (days === 0) {
        return "üö® H·∫æT H·∫†N H√îM NAY!";
    } else {
        return `‚ùå ƒê√£ qu√° h·∫°n: ${Math.abs(days)} ng√†y`;
    }
}

// Bi·∫øn ph√¢n trang
let currentPage = 1;
const itemsPerPage = 5;
let allExpiryItems = [];

// H√†m hi·ªÉn th·ªã chi ti·∫øt c·∫£nh b√°o h·∫øt h·∫°n
function displayExpiryDetails() {
    const detailsContainer = document.getElementById('expiry-details');
    
    // L·∫•y d·ªØ li·ªáu VPS v√† Accounts
    Promise.all([
        fetch('/api/vps').then(r => r.json()),
        fetch('/api/accounts').then(r => r.json())
    ]).then(([vpsData, accData]) => {
        allExpiryItems = [];
        
        // Th√™m VPS v√†o danh s√°ch
        vpsData.forEach(vps => {
            if (vps.expiry) {
                const daysLeft = calculateDaysUntilExpiry(vps.expiry);
                if (daysLeft !== null) {
                    allExpiryItems.push({
                        type: 'VPS',
                        name: vps.name || vps.id,
                        service: vps.service || 'Unknown',
                        ip: vps.ip || 'N/A',
                        daysLeft: daysLeft,
                        expiry: vps.expiry
                    });
                }
            }
        });
        
        // Th√™m Accounts v√†o danh s√°ch
        accData.forEach(acc => {
            if (acc.expiry) {
                const daysLeft = calculateDaysUntilExpiry(acc.expiry);
                if (daysLeft !== null) {
                    allExpiryItems.push({
                        type: 'Account',
                        name: acc.username || acc.id,
                        service: acc.service || 'Unknown',
                        daysLeft: daysLeft,
                        expiry: acc.expiry
                    });
                }
            }
        });
        
        // S·∫Øp x·∫øp theo th·ªùi gian h·∫øt h·∫°n (g·∫ßn nh·∫•t tr∆∞·ªõc)
        allExpiryItems.sort((a, b) => a.daysLeft - b.daysLeft);
        
        // C·∫≠p nh·∫≠t summary
        document.getElementById('expiry-summary').textContent = `${allExpiryItems.length} items`;
        
        // Hi·ªÉn th·ªã
        if (allExpiryItems.length === 0) {
            detailsContainer.innerHTML = '<div class="alert alert-success py-3 mb-0"><small>‚úÖ Kh√¥ng c√≥ items n√†o s·∫Øp h·∫øt h·∫°n!</small></div>';
            document.getElementById('pagination-container').style.display = 'none';
        } else {
            renderExpiryTable();
            setupPagination();
        }
    }).catch(error => {
        console.error('Error loading expiry details:', error);
        detailsContainer.innerHTML = '<div class="alert alert-danger py-3 mb-0"><small>‚ùå L·ªói khi t·∫£i th√¥ng tin h·∫øt h·∫°n</small></div>';
        document.getElementById('pagination-container').style.display = 'none';
    });
}

// H√†m render b·∫£ng v·ªõi ph√¢n trang
function renderExpiryTable() {
    const detailsContainer = document.getElementById('expiry-details');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageItems = allExpiryItems.slice(startIndex, endIndex);
    
    let html = '<div class="table-responsive"><table class="table table-sm table-striped mb-0">';
    html += '<thead class="table-light"><tr><th class="py-1">Lo·∫°i</th><th class="py-1">T√™n</th><th class="py-1">Service</th><th class="py-1">IP</th><th class="py-1">T√¨nh tr·∫°ng</th></tr></thead><tbody>';
    
    pageItems.forEach(item => {
        const daysMessage = formatDaysMessage(item.daysLeft);
        const rowClass = item.daysLeft < 0 ? 'table-danger' : 
                       item.daysLeft === 0 ? 'table-warning' : 
                       item.daysLeft <= 3 ? 'table-info' : '';
        
        html += `<tr class="${rowClass}">
            <td class="py-1"><small><strong>${item.type}</strong></small></td>
            <td class="py-1"><small>${item.name}</small></td>
            <td class="py-1"><small>${item.service}</small></td>
            <td class="py-1"><small>${item.ip || 'N/A'}</small></td>
            <td class="py-1"><span class="badge bg-${item.daysLeft < 0 ? 'danger' : item.daysLeft === 0 ? 'warning' : item.daysLeft <= 3 ? 'info' : 'secondary'} badge-sm">${daysMessage}</span></td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    detailsContainer.innerHTML = html;
}

// H√†m setup ph√¢n trang
function setupPagination() {
    const totalPages = Math.ceil(allExpiryItems.length / itemsPerPage);
    const paginationContainer = document.getElementById('pagination-container');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const pageNumbers = document.getElementById('page-numbers');
    const paginationInfo = document.getElementById('pagination-info');
    
    if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
    }
    
    paginationContainer.style.display = 'flex';
    
    // C·∫≠p nh·∫≠t n√∫t Previous
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderExpiryTable();
            setupPagination();
        }
    };
    
    // C·∫≠p nh·∫≠t n√∫t Next
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderExpiryTable();
            setupPagination();
        }
    };
    
    // Hi·ªÉn th·ªã s·ªë trang
    let pageHtml = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        pageHtml += `<button class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-outline-secondary'} me-1" 
                     onclick="goToPage(${i})" ${isActive ? 'disabled' : ''}>${i}</button>`;
    }
    
    pageNumbers.innerHTML = pageHtml;
    updatePaginationInfo();
}

// H√†m chuy·ªÉn trang
function goToPage(page) {
    currentPage = page;
    renderExpiryTable();
    setupPagination();
}

// H√†m c·∫≠p nh·∫≠t th√¥ng tin ph√¢n trang
function updatePaginationInfo() {
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, allExpiryItems.length);
    document.getElementById('pagination-info').textContent = 
        `Hi·ªÉn th·ªã ${startIndex}-${endIndex} c·ªßa ${allExpiryItems.length} items`;
}

// C·∫≠p nh·∫≠t d·ªØ li·ªáu dashboard
fetch('/api/vps').then(r=>r.json()).then(data=>{
  document.getElementById('vps-count').textContent = data.length;
});
fetch('/api/accounts').then(r=>r.json()).then(data=>{
  document.getElementById('account-count').textContent = data.length;
});
fetch('/api/expiry-warnings').then(r=>r.json()).then(data=>{
  if (data.status === 'success') {
    document.getElementById('expiry-count').textContent = data.warnings ? data.warnings.length : 0;
  } else {
    document.getElementById('expiry-count').textContent = '0';
  }
});

// Load chi ti·∫øt c·∫£nh b√°o h·∫øt h·∫°n
displayExpiryDetails();

// C·∫≠p nh·∫≠t th·ªùi gian c·∫≠p nh·∫≠t cu·ªëi
function updateLastUpdateTime() {
  const now = new Date();
  document.getElementById('last-update-time').textContent = now.toLocaleString('vi-VN');
}

// Ki·ªÉm tra URL parameters khi trang load
document.addEventListener('DOMContentLoaded', function() {
    checkUrlParams();
    updateLastUpdateTime();
    
    // C·∫≠p nh·∫≠t th·ªùi gian m·ªói ph√∫t
    setInterval(updateLastUpdateTime, 60000);
});
</script>
{% endblock %} 