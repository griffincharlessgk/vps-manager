{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Dashboard</h1>

<!-- Th√¥ng b√°o l·ªói access denied -->
<div id="access-denied-alert" class="alert alert-danger" style="display:none;">
    <h5>üö´ Truy c·∫≠p b·ªã t·ª´ ch·ªëi</h5>
    <p>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n l√Ω user. Ch·ªâ admin m·ªõi c√≥ th·ªÉ truy c·∫≠p t√≠nh nƒÉng n√†y.</p>
</div>

<div class="row">
  <div class="col-md-4">
    <div class="card text-bg-primary mb-3">
      <div class="card-body">
        <h5 class="card-title">S·ªë l∆∞·ª£ng VPS</h5>
        <p class="card-text" id="vps-count">0</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-success mb-3">
      <div class="card-body">
        <h5 class="card-title">S·ªë l∆∞·ª£ng t√†i kho·∫£n</h5>
        <p class="card-text" id="account-count">0</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-warning mb-3">
      <div class="card-body">
        <h5 class="card-title">C·∫£nh b√°o h·∫øt h·∫°n</h5>
        <p class="card-text" id="expiry-count">0</p>
      </div>
    </div>
  </div>
</div>

<!-- Th√™m section hi·ªÉn th·ªã chi ti·∫øt c·∫£nh b√°o h·∫øt h·∫°n -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Chi ti·∫øt c·∫£nh b√°o h·∫øt h·∫°n</h5>
        <div id="expiry-pagination-info" class="text-muted small">
          <!-- Th√¥ng tin ph√¢n trang s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>
      </div>
      <div class="card-body">
        <div id="expiry-details">
          <!-- Chi ti·∫øt c·∫£nh b√°o s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
        </div>
        <!-- Ph√¢n trang -->
        <nav aria-label="Ph√¢n trang c·∫£nh b√°o h·∫øt h·∫°n" id="expiry-pagination" style="display: none;">
          <ul class="pagination justify-content-center" id="pagination-list">
            <!-- C√°c n√∫t trang s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông ·ªü ƒë√¢y -->
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-4">
    <div class="card text-bg-info mb-3">
      <div class="card-body">
        <h5 class="card-title">D·ªãch v·ª• BitLaunch</h5>
        <p class="card-text">Qu·∫£n l√Ω t√†i kho·∫£n, s·ªë d∆∞, l·ªãch s·ª≠ giao d·ªãch, n·∫°p ti·ªÅn, server, SSH key...</p>
        <a href="/bitlaunch" class="btn btn-outline-light">S·ª≠ d·ª•ng API BitLaunch</a>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-success mb-3">
      <div class="card-body">
        <h5 class="card-title">D·ªãch v·ª• ZingProxy</h5>
        <p class="card-text">Qu·∫£n l√Ω t√†i kho·∫£n, s·ªë d∆∞, proxy, tr·∫°ng th√°i, ng√†y h·∫øt h·∫°n qua API ZingProxy.</p>
        <a href="/zingproxy" class="btn btn-outline-light">S·ª≠ d·ª•ng API ZingProxy</a>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-warning mb-3">
      <div class="card-body">
        <h5 class="card-title">D·ªãch v·ª• CloudFly</h5>
        <p class="card-text">Qu·∫£n l√Ω VPS v√† t√†i kho·∫£n CloudFly th√¥ng qua API.</p>
        <a href="/cloudfly" class="btn btn-outline-light">S·ª≠ d·ª•ng API CloudFly</a>
      </div>
    </div>
  </div>
</div>

<!-- Th√™m row m·ªõi cho Rocket Chat -->
<div class="row">
  <div class="col-md-4">
    <div class="card text-bg-danger mb-3">
      <div class="card-body">
        <h5 class="card-title">Rocket Chat</h5>
        <p class="card-text">C·∫•u h√¨nh v√† g·ª≠i th√¥ng b√°o t·ª± ƒë·ªông v·ªÅ t√†i kho·∫£n s·∫Øp h·∫øt h·∫°n, balance th·∫•p qua Rocket Chat.</p>
        <a href="/rocket-chat" class="btn btn-outline-light">C·∫•u h√¨nh Rocket Chat</a>
      </div>
    </div>
  </div>
</div>

<script>
// Ki·ªÉm tra URL parameters ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o l·ªói
function checkUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    
    if (error === 'access_denied') {
        document.getElementById('access-denied-alert').style.display = 'block';
        // X√≥a parameter kh·ªèi URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

// H√†m t√≠nh s·ªë ng√†y c√≤n l·∫°i
function calculateDaysUntilExpiry(expiryStr) {
    if (!expiryStr) return null;
    try {
        const expiryDate = new Date(expiryStr);
        const today = new Date();
        const diffTime = expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    } catch {
        return null;
    }
}

// H√†m format message cho s·ªë ng√†y
function formatDaysMessage(days) {
    if (days > 0) {
        return `‚è∞ C√≤n l·∫°i: ${days} ng√†y`;
    } else if (days === 0) {
        return "üö® H·∫æT H·∫†N H√îM NAY!";
    } else {
        return `‚ùå ƒê√£ qu√° h·∫°n: ${Math.abs(days)} ng√†y`;
    }
}

// Bi·∫øn global cho pagination
let allExpiryItems = [];
let currentPage = 1;
const itemsPerPage = 6;

// H√†m hi·ªÉn th·ªã chi ti·∫øt c·∫£nh b√°o h·∫øt h·∫°n
function displayExpiryDetails() {
    const detailsContainer = document.getElementById('expiry-details');
    
    // L·∫•y d·ªØ li·ªáu VPS v√† Accounts
    Promise.all([
        fetch('/api/vps').then(r => r.json()),
        fetch('/api/accounts').then(r => r.json())
    ]).then(([vpsData, accData]) => {
        allExpiryItems = [];
        
        // Th√™m VPS v√†o danh s√°ch
        vpsData.forEach(vps => {
            if (vps.expiry) {
                const daysLeft = calculateDaysUntilExpiry(vps.expiry);
                if (daysLeft !== null) {
                    allExpiryItems.push({
                        type: 'VPS',
                        name: vps.name || vps.id,
                        service: vps.service || 'Unknown',
                        ip: vps.ip || 'N/A',
                        daysLeft: daysLeft,
                        expiry: vps.expiry
                    });
                }
            }
        });
        
        // Th√™m Accounts v√†o danh s√°ch
        accData.forEach(acc => {
            if (acc.expiry) {
                const daysLeft = calculateDaysUntilExpiry(acc.expiry);
                if (daysLeft !== null) {
                    allExpiryItems.push({
                        type: 'Account',
                        name: acc.username || acc.id,
                        service: acc.service || 'Unknown',
                        daysLeft: daysLeft,
                        expiry: acc.expiry
                    });
                }
            }
        });
        
        // S·∫Øp x·∫øp theo th·ªùi gian h·∫øt h·∫°n (g·∫ßn nh·∫•t tr∆∞·ªõc)
        allExpiryItems.sort((a, b) => a.daysLeft - b.daysLeft);
        
        // Reset v·ªÅ trang 1 v√† hi·ªÉn th·ªã
        currentPage = 1;
        renderExpiryTable();
    }).catch(error => {
        console.error('Error loading expiry details:', error);
        detailsContainer.innerHTML = '<div class="alert alert-danger">‚ùå L·ªói khi t·∫£i th√¥ng tin h·∫øt h·∫°n</div>';
    });
}

// H√†m render b·∫£ng v·ªõi pagination
function renderExpiryTable() {
    const detailsContainer = document.getElementById('expiry-details');
    const paginationInfo = document.getElementById('expiry-pagination-info');
    const pagination = document.getElementById('expiry-pagination');
    
    if (allExpiryItems.length === 0) {
        detailsContainer.innerHTML = '<div class="alert alert-success">‚úÖ Kh√¥ng c√≥ items n√†o s·∫Øp h·∫øt h·∫°n!</div>';
        pagination.style.display = 'none';
        paginationInfo.innerHTML = '';
        return;
    }
    
    // T√≠nh to√°n pagination
    const totalPages = Math.ceil(allExpiryItems.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, allExpiryItems.length);
    const currentItems = allExpiryItems.slice(startIndex, endIndex);
    
    // Hi·ªÉn th·ªã th√¥ng tin pagination
    paginationInfo.innerHTML = `Trang ${currentPage}/${totalPages} - Hi·ªÉn th·ªã ${startIndex + 1}-${endIndex} trong ${allExpiryItems.length} items`;
    
    // Hi·ªÉn th·ªã b·∫£ng
    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += '<thead><tr><th>Lo·∫°i</th><th>T√™n</th><th>Service</th><th>IP</th><th>T√¨nh tr·∫°ng</th></tr></thead><tbody>';
    
    currentItems.forEach(item => {
        const daysMessage = formatDaysMessage(item.daysLeft);
        const rowClass = item.daysLeft < 0 ? 'table-danger' : 
                       item.daysLeft === 0 ? 'table-warning' : 
                       item.daysLeft <= 3 ? 'table-info' : '';
        
        html += `<tr class="${rowClass}">
            <td><strong>${item.type}</strong></td>
            <td>${item.name}</td>
            <td>${item.service}</td>
            <td>${item.ip || 'N/A'}</td>
            <td><span class="badge bg-${item.daysLeft < 0 ? 'danger' : item.daysLeft === 0 ? 'warning' : item.daysLeft <= 3 ? 'info' : 'secondary'}">${daysMessage}</span></td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    detailsContainer.innerHTML = html;
    
    // Hi·ªÉn th·ªã/·∫©n n√∫t ph√¢n trang
    if (totalPages > 1) {
        pagination.style.display = 'block';
        createPaginationButtons(totalPages);
    } else {
        pagination.style.display = 'none';
    }
}

// H√†m t·∫°o n√∫t ph√¢n trang
function createPaginationButtons(totalPages) {
    const paginationList = document.getElementById('pagination-list');
    let html = '';
    
    // N√∫t << (Trang ƒë·∫ßu)
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(1)" ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>&laquo;&laquo;</a>
    </li>`;
    
    // N√∫t < (Trang tr∆∞·ªõc)
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>&laquo;</a>
    </li>`;
    
    // T√≠nh to√°n ph·∫°m vi trang hi·ªÉn th·ªã
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    // ƒêi·ªÅu ch·ªânh ƒë·ªÉ lu√¥n hi·ªÉn th·ªã 5 trang n·∫øu c√≥ th·ªÉ
    if (endPage - startPage < 4) {
        if (startPage === 1) {
            endPage = Math.min(totalPages, startPage + 4);
        } else if (endPage === totalPages) {
            startPage = Math.max(1, endPage - 4);
        }
    }
    
    // N√∫t ... n·∫øu c·∫ßn
    if (startPage > 1) {
        html += `<li class="page-item disabled">
            <span class="page-link">...</span>
        </li>`;
    }
    
    // C√°c n√∫t trang s·ªë
    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
        </li>`;
    }
    
    // N√∫t ... n·∫øu c·∫ßn
    if (endPage < totalPages) {
        html += `<li class="page-item disabled">
            <span class="page-link">...</span>
        </li>`;
    }
    
    // N√∫t > (Trang sau)
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>&raquo;</a>
    </li>`;
    
    // N√∫t >> (Trang cu·ªëi)
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>&raquo;&raquo;</a>
    </li>`;
    
    paginationList.innerHTML = html;
}

// H√†m chuy·ªÉn ƒë·∫øn trang c·ª• th·ªÉ
function goToPage(page) {
    const totalPages = Math.ceil(allExpiryItems.length / itemsPerPage);
    
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        renderExpiryTable();
    }
}

// H√†m chuy·ªÉn trang (gi·ªØ l·∫°i cho t∆∞∆°ng th√≠ch)
function changePage(direction) {
    const totalPages = Math.ceil(allExpiryItems.length / itemsPerPage);
    const newPage = currentPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderExpiryTable();
    }
}

// C·∫≠p nh·∫≠t d·ªØ li·ªáu dashboard
fetch('/api/vps').then(r=>r.json()).then(data=>{
  document.getElementById('vps-count').textContent = data.length;
});
fetch('/api/accounts').then(r=>r.json()).then(data=>{
  document.getElementById('account-count').textContent = data.length;
});
fetch('/api/expiry-warnings').then(r=>r.json()).then(data=>{
  if (data.status === 'success') {
    document.getElementById('expiry-count').textContent = data.warnings ? data.warnings.length : 0;
  } else {
    document.getElementById('expiry-count').textContent = '0';
  }
});

// Load chi ti·∫øt c·∫£nh b√°o h·∫øt h·∫°n
displayExpiryDetails();

// C·∫≠p nh·∫≠t th·ªùi gian c·∫≠p nh·∫≠t cu·ªëi
function updateLastUpdateTime() {
  const now = new Date();
  document.getElementById('last-update-time').textContent = now.toLocaleString('vi-VN');
}

// Ki·ªÉm tra URL parameters khi trang load
document.addEventListener('DOMContentLoaded', function() {
    checkUrlParams();
    updateLastUpdateTime();
    
    // C·∫≠p nh·∫≠t th·ªùi gian m·ªói ph√∫t
    setInterval(updateLastUpdateTime, 60000);
});
</script>
{% endblock %} 