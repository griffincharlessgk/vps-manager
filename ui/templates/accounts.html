{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Danh s√°ch t√†i kho·∫£n</h1>
<div class="row mb-3">
  <div class="col-md-4">
    <input type="text" class="form-control" id="search-acc" placeholder="T√¨m ki·∫øm theo d·ªãch v·ª•, t√™n ƒëƒÉng nh·∫≠p...">
  </div>
  <div class="col-md-3">
    <input type="text" class="form-control" id="filter-service" placeholder="L·ªçc theo d·ªãch v·ª•...">
  </div>
  <div class="col-md-2">
    <select class="form-select" id="rows-per-page-acc">
      <option value="10">10 d√≤ng/trang</option>
      <option value="20">20 d√≤ng/trang</option>
      <option value="50">50 d√≤ng/trang</option>
    </select>
  </div>
  <div class="col-md-3">
    <button type="button" class="btn btn-info" id="send-rocket-notification-btn">
      üì¢ G·ª≠i th√¥ng b√°o Rocket Chat
    </button>
  </div>
</div>
<div class="card mb-4 admin-only">
  <div class="card-body">
    <form id="acc-form">
      <input type="hidden" id="acc-id" name="id">
      <div class="row g-2 align-items-end">
        <div class="col-md-2">
          <label class="form-label">D·ªãch v·ª•</label>
          <input type="text" class="form-control" id="acc-service" name="service" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
          <input type="text" class="form-control" id="acc-username" name="username" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">M·∫≠t kh·∫©u</label>
          <input type="text" class="form-control" id="acc-password" name="password">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ng√†y h·∫øt h·∫°n</label>
          <input type="date" class="form-control" id="acc-expiry" name="expiry">
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary" id="acc-submit">Th√™m t√†i kho·∫£n</button>
          <button type="button" class="btn btn-secondary d-none" id="acc-cancel">H·ªßy</button>
        </div>
      </div>
    </form>
  </div>
</div>
<table class="table table-striped" id="acc-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Ngu·ªìn</th>
      <th>D·ªãch v·ª•</th>
      <th>T√™n ƒëƒÉng nh·∫≠p</th>
      <th>S·ªë d∆∞</th>
      <th>Ng√†y h·∫øt h·∫°n</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<nav>
  <ul class="pagination" id="acc-pagination"></ul>
</nav>
<!-- Modal x√°c nh·∫≠n x√≥a -->
<div class="modal fade" id="deleteAccModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">X√°c nh·∫≠n x√≥a t√†i kho·∫£n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n <b id="del-acc-username"></b> (ID: <span id="del-acc-id"></span>)?</p>
        <p>Nh·∫≠p l·∫°i <b>ID t√†i kho·∫£n</b> ƒë·ªÉ x√°c nh·∫≠n:</p>
        <input type="text" class="form-control" id="confirm-del-acc-id" placeholder="Nh·∫≠p ID t√†i kho·∫£n">
        <div class="invalid-feedback">ID kh√¥ng kh·ªõp!</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-acc-btn" disabled>X√≥a</button>
      </div>
    </div>
  </div>
</div>
        <!-- Th√™m section hi·ªÉn th·ªã t√†i kho·∫£n ƒë√£ h·∫øt h·∫°n -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">üö® T√†i kho·∫£n ƒë√£ h·∫øt h·∫°n</h5>
              </div>
              <div class="card-body">
                <div id="expired-accounts-list">
                  <!-- Danh s√°ch t√†i kho·∫£n ƒë√£ h·∫øt h·∫°n s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Th√™m section hi·ªÉn th·ªã t√†i kho·∫£n s·∫Øp h·∫øt h·∫°n -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-warning">
              <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">‚ö†Ô∏è T√†i kho·∫£n s·∫Øp h·∫øt h·∫°n</h5>
              </div>
              <div class="card-body">
                <div id="expiring-accounts-list">
                  <!-- Danh s√°ch t√†i kho·∫£n s·∫Øp h·∫øt h·∫°n s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
              </div>
            </div>
          </div>
        </div>
<script>
let accData = [];
let currentPageAcc = 1;
let rowsPerPageAcc = 10;

function filterAccounts() {
  const search = document.getElementById('search-acc').value.toLowerCase();
  const serviceFilter = document.getElementById('filter-service').value.toLowerCase();
  return accData.filter(acc => {
    let ok = true;
    if (search) {
      ok = (acc.service && acc.service.toLowerCase().includes(search)) ||
           (acc.username && acc.username.toLowerCase().includes(search));
    }
    if (ok && serviceFilter) {
      ok = acc.service && acc.service.toLowerCase().includes(serviceFilter);
    }
    return ok;
  });
}

function renderAccTable() {
  const tbody = document.querySelector('#acc-table tbody');
  tbody.innerHTML = '';
  const filtered = filterAccounts();
  const total = filtered.length;
  rowsPerPageAcc = parseInt(document.getElementById('rows-per-page-acc').value);
  const start = (currentPageAcc-1)*rowsPerPageAcc;
  const end = start + rowsPerPageAcc;
  filtered.slice(start, end).forEach(acc => {
    const tr = document.createElement('tr');
    
    // Hi·ªÉn th·ªã ngu·ªìn v·ªõi badge m√†u
    let sourceBadge = '';
    if (acc.source === 'bitlaunch') {
      sourceBadge = '<span class="badge bg-info">BitLaunch</span>';
    } else if (acc.source === 'zingproxy') {
      sourceBadge = '<span class="badge bg-success">ZingProxy</span>';
    } else if (acc.source === 'cloudfly') {
      sourceBadge = '<span class="badge bg-warning">CloudFly</span>';
    } else {
      sourceBadge = '<span class="badge bg-secondary">Manual</span>';
    }
    
    // Hi·ªÉn th·ªã s·ªë d∆∞ v·ªõi format
    let balanceDisplay = '';
    if (acc.balance !== undefined && acc.balance !== null) {
      balanceDisplay = `$${acc.balance.toLocaleString()}`;
    } else {
      balanceDisplay = 'N/A';
    }
    
    // X√°c ƒë·ªãnh actions d·ª±a tr√™n ngu·ªìn
    let actions = '';
    if (acc.source === 'manual') {
      actions = `
        <button class="btn btn-sm btn-warning me-1 admin-only" onclick='editAcc(${JSON.stringify(acc)})'>S·ª≠a</button>
        <button class="btn btn-sm btn-danger admin-only" onclick='showDeleteAccModal("${acc.id}", "${acc.username||''}")'>X√≥a</button>
      `;
    } else if (acc.source === 'bitlaunch') {
      actions = `
        <button class="btn btn-sm btn-info me-1" onclick='viewBitLaunchAccount("${acc.id}")'>Chi ti·∫øt</button>
        <span class="text-muted small">T·ª± ƒë·ªông t·ª´ BitLaunch</span>
      `;
    } else if (acc.source === 'zingproxy') {
      actions = `
        <button class="btn btn-sm btn-info me-1" onclick='viewZingProxyAccount("${acc.id}")'>Chi ti·∫øt</button>
        <span class="text-muted small">T·ª± ƒë·ªông t·ª´ ZingProxy</span>
      `;
    } else if (acc.source === 'cloudfly') {
      actions = `
        <button class="btn btn-sm btn-info me-1" onclick='viewCloudFlyAccount("${acc.id}")'>Chi ti·∫øt</button>
        <span class="text-muted small">T·ª± ƒë·ªông t·ª´ CloudFly</span>
      `;
    }
    
    tr.innerHTML = `
      <td>${acc.id}</td>
      <td>${sourceBadge}</td>
      <td>${acc.service || ''}</td>
      <td>${acc.username || ''}</td>
      <td>${balanceDisplay}</td>
      <td>${acc.expiry || ''}</td>
      <td>${actions}</td>
    `;
    tbody.appendChild(tr);
  });
  renderAccPagination(total);
  showAdminActions();
}

function renderAccPagination(total) {
  const ul = document.getElementById('acc-pagination');
  ul.innerHTML = '';
  const pages = Math.ceil(total/rowsPerPageAcc);
  for (let i=1; i<=pages; i++) {
    const li = document.createElement('li');
    li.className = 'page-item'+(i===currentPageAcc?' active':'');
    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
    li.onclick = function(e){ e.preventDefault(); currentPageAcc=i; renderAccTable(); };
    ul.appendChild(li);
  }
}

function loadAccounts() {
  fetch('/api/accounts').then(r=>r.json()).then(data=>{
    accData = data;
    currentPageAcc = 1;
    renderAccTable();
    displayExpiryWarnings(); // Hi·ªÉn th·ªã c·∫£nh b√°o h·∫øt h·∫°n
  });
}

// H√†m hi·ªÉn th·ªã t√†i kho·∫£n ƒë√£ h·∫øt h·∫°n v√† s·∫Øp h·∫øt h·∫°n
function displayExpiryWarnings() {
  const today = new Date();
  const expiredAccounts = [];
  const expiringAccounts = [];
  
  accData.forEach(acc => {
    if (acc.expiry && acc.source === 'manual') {
      try {
        const expiryDate = new Date(acc.expiry);
        const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysLeft < 0) {
          // T√†i kho·∫£n ƒë√£ h·∫øt h·∫°n
          expiredAccounts.push({...acc, daysLeft: Math.abs(daysLeft)});
        } else if (daysLeft <= 7) {
          // T√†i kho·∫£n s·∫Øp h·∫øt h·∫°n
          expiringAccounts.push({...acc, daysLeft: daysLeft});
        }
      } catch (e) {
        console.error('Error parsing expiry date:', e);
      }
    }
  });
  
  // Hi·ªÉn th·ªã t√†i kho·∫£n ƒë√£ h·∫øt h·∫°n
  const expiredContainer = document.getElementById('expired-accounts-list');
  if (expiredAccounts.length > 0) {
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>T√™n t√†i kho·∫£n</th><th>D·ªãch v·ª•</th><th>Ng√†y h·∫øt h·∫°n</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody>';
    
    expiredAccounts.forEach(acc => {
      html += `<tr class="table-danger">
        <td><strong>${acc.username || acc.id}</strong></td>
        <td>${acc.service || 'N/A'}</td>
        <td>${acc.expiry}</td>
        <td><span class="badge bg-danger">üö® ƒê√£ h·∫øt h·∫°n ${acc.daysLeft} ng√†y</span></td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
    expiredContainer.innerHTML = html;
  } else {
    expiredContainer.innerHTML = '<div class="alert alert-success">‚úÖ Kh√¥ng c√≥ t√†i kho·∫£n n√†o ƒë√£ h·∫øt h·∫°n!</div>';
  }
  
  // Hi·ªÉn th·ªã t√†i kho·∫£n s·∫Øp h·∫øt h·∫°n
  const expiringContainer = document.getElementById('expiring-accounts-list');
  if (expiringAccounts.length > 0) {
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>T√™n t√†i kho·∫£n</th><th>D·ªãch v·ª•</th><th>Ng√†y h·∫øt h·∫°n</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody>';
    
    expiringAccounts.forEach(acc => {
      let badgeClass = 'bg-warning';
      let statusText = `C√≤n ${acc.daysLeft} ng√†y`;
      
      if (acc.daysLeft === 0) {
        badgeClass = 'bg-danger';
        statusText = 'üö® H·∫æT H·∫†N H√îM NAY!';
      } else if (acc.daysLeft === 1) {
        badgeClass = 'bg-warning';
        statusText = '‚ö†Ô∏è H·∫øt h·∫°n ng√†y mai';
      }
      
      html += `<tr class="table-warning">
        <td><strong>${acc.username || acc.id}</strong></td>
        <td>${acc.service || 'N/A'}</td>
        <td>${acc.expiry}</td>
        <td><span class="badge ${badgeClass}">${statusText}</span></td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
    expiringContainer.innerHTML = html;
  } else {
    expiringContainer.innerHTML = '<div class="alert alert-success">‚úÖ Kh√¥ng c√≥ t√†i kho·∫£n n√†o s·∫Øp h·∫øt h·∫°n!</div>';
  }
}

document.getElementById('search-acc').oninput = function(){ currentPageAcc=1; renderAccTable(); };
document.getElementById('filter-service').oninput = function(){ currentPageAcc=1; renderAccTable(); };
document.getElementById('rows-per-page-acc').onchange = function(){ currentPageAcc=1; renderAccTable(); };

function editAcc(acc) {
  document.getElementById('acc-id').value = acc.id;
  document.getElementById('acc-service').value = acc.service || '';
  document.getElementById('acc-username').value = acc.username || '';
  document.getElementById('acc-password').value = acc.password || '';
  document.getElementById('acc-expiry').value = acc.expiry || '';
  document.getElementById('acc-submit').textContent = 'C·∫≠p nh·∫≠t t√†i kho·∫£n';
  document.getElementById('acc-cancel').classList.remove('d-none');
}

document.getElementById('acc-cancel').onclick = function() {
  document.getElementById('acc-form').reset();
  document.getElementById('acc-id').value = '';
  document.getElementById('acc-submit').textContent = 'Th√™m t√†i kho·∫£n';
  this.classList.add('d-none');
};

document.getElementById('acc-form').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('acc-id').value;
  const service = document.getElementById('acc-service').value;
  const username = document.getElementById('acc-username').value;
  const password = document.getElementById('acc-password').value;
  const expiry = document.getElementById('acc-expiry').value;
  let acc = { id: id || crypto.randomUUID(), service, username, password, expiry };
  if (!id) {
    fetch('/api/accounts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(acc)
    }).then(()=>{ loadAccounts(); this.reset(); });
  } else {
    fetch('/api/accounts/' + id, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(acc)
    }).then(()=>{
      loadAccounts();
      this.reset();
      document.getElementById('acc-id').value = '';
      document.getElementById('acc-submit').textContent = 'Th√™m t√†i kho·∫£n';
      document.getElementById('acc-cancel').classList.add('d-none');
    });
  }
};

// Modal x√°c nh·∫≠n x√≥a n√¢ng cao
let deleteAccId = '';
function showDeleteAccModal(id, username) {
  deleteAccId = id;
  document.getElementById('del-acc-username').textContent = username;
  document.getElementById('del-acc-id').textContent = id;
  document.getElementById('confirm-del-acc-id').value = '';
  document.getElementById('confirm-del-acc-id').classList.remove('is-invalid');
  document.getElementById('confirm-delete-acc-btn').disabled = true;
  var modal = new bootstrap.Modal(document.getElementById('deleteAccModal'));
  modal.show();
}
document.getElementById('confirm-del-acc-id').oninput = function() {
  if (this.value === deleteAccId) {
    this.classList.remove('is-invalid');
    document.getElementById('confirm-delete-acc-btn').disabled = false;
  } else {
    this.classList.add('is-invalid');
    document.getElementById('confirm-delete-acc-btn').disabled = true;
  }
};
document.getElementById('confirm-delete-acc-btn').onclick = function() {
  fetch('/api/accounts/' + deleteAccId, { method: 'DELETE' })
    .then(()=>{ loadAccounts(); });
  var modal = bootstrap.Modal.getInstance(document.getElementById('deleteAccModal'));
  modal.hide();
};

// Th√™m c√°c h√†m ƒë·ªÉ xem chi ti·∫øt t√†i kho·∫£n t·ª´ API
function viewBitLaunchAccount(accId) {
  // Redirect ƒë·∫øn trang BitLaunch ƒë·ªÉ xem chi ti·∫øt
  window.open('/bitlaunch', '_blank');
}

function viewZingProxyAccount(accId) {
  // Redirect ƒë·∫øn trang ZingProxy ƒë·ªÉ xem chi ti·∫øt
  window.open('/zingproxy', '_blank');
}

function viewCloudFlyAccount(accId) {
  // Redirect ƒë·∫øn trang CloudFly ƒë·ªÉ xem chi ti·∫øt
  window.open('/cloudfly', '_blank');
}

// Load accounts data khi trang load
loadAccounts();

// G·ª≠i th√¥ng b√°o Rocket Chat t·ª´ trang t√†i kho·∫£n
document.getElementById('send-rocket-notification-btn').addEventListener('click', function() {
  // Hi·ªÉn th·ªã modal x√°c nh·∫≠n
  const modal = `
    <div class="modal fade" id="rocketNotificationModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">G·ª≠i th√¥ng b√°o t√†i kho·∫£n ƒë·∫øn Rocket Chat</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Lo·∫°i th√¥ng b√°o</label>
              <select class="form-select" id="notification-type">
                <option value="expiry">Th√¥ng b√°o t√†i kho·∫£n s·∫Øp h·∫øt h·∫°n</option>
                <option value="daily">B√°o c√°o t·ªïng h·ª£p h√†ng ng√†y</option>
                <option value="detailed">Th√¥ng tin chi ti·∫øt t√†i kho·∫£n</option>
              </select>
            </div>
            <div class="mb-3" id="warning-days-group">
              <label class="form-label">S·ªë ng√†y c·∫£nh b√°o tr∆∞·ªõc</label>
              <select class="form-select" id="warning-days-modal">
                <option value="1">1 ng√†y</option>
                <option value="3">3 ng√†y</option>
                <option value="7" selected>7 ng√†y</option>
                <option value="14">14 ng√†y</option>
                <option value="30">30 ng√†y</option>
              </select>
            </div>
            <div id="notification-result-modal"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="btn btn-primary" id="confirm-send-notification">G·ª≠i th√¥ng b√°o</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Th√™m modal v√†o body
  document.body.insertAdjacentHTML('beforeend', modal);
  
  const modalElement = document.getElementById('rocketNotificationModal');
  const modalInstance = new bootstrap.Modal(modalElement);
  modalInstance.show();
  
  // X·ª≠ l√Ω thay ƒë·ªïi lo·∫°i th√¥ng b√°o
  document.getElementById('notification-type').addEventListener('change', function() {
    const warningDaysGroup = document.getElementById('warning-days-group');
    if (this.value === 'daily') {
      warningDaysGroup.style.display = 'none';
    } else {
      warningDaysGroup.style.display = 'block';
    }
  });
  
  // X·ª≠ l√Ω g·ª≠i th√¥ng b√°o
  document.getElementById('confirm-send-notification').addEventListener('click', function() {
    const notificationType = document.getElementById('notification-type').value;
    const warningDays = parseInt(document.getElementById('warning-days-modal').value);
    const resultDiv = document.getElementById('notification-result-modal');
    
    let endpoint = '';
    let data = {};
    
    if (notificationType === 'expiry') {
      endpoint = '/api/rocket-chat/send-account-notification';
      data = { warning_days: warningDays };
    } else if (notificationType === 'daily') {
      endpoint = '/api/rocket-chat/send-daily-summary';
      data = {};
    } else if (notificationType === 'detailed') {
      endpoint = '/api/rocket-chat/send-detailed-info';
      data = {};
    }
    
    fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        // ƒê√≥ng modal sau 2 gi√¢y
        setTimeout(() => {
          modalInstance.hide();
          document.body.removeChild(modalElement);
        }, 2000);
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
      }
    })
    .catch(error => {
      console.error('Error sending notification:', error);
      resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói khi g·ª≠i th√¥ng b√°o</div>';
    });
  });
  
  // X·ª≠ l√Ω khi modal ƒë√≥ng
  modalElement.addEventListener('hidden.bs.modal', function() {
    document.body.removeChild(modalElement);
  });
});
</script>
{% endblock %} 