{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">C·∫•u h√¨nh Rocket Chat</h2>

<div class="row">
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">C·∫•u h√¨nh th√¥ng b√°o</h5>
      </div>
      <div class="card-body">
        <form id="rocket-chat-config-form">
          <div class="mb-3">
            <label class="form-label">Auth Token</label>
            <input type="password" class="form-control" id="auth-token" placeholder="Nh·∫≠p Auth Token t·ª´ Rocket Chat" required>
            <div class="form-text">L·∫•y t·ª´ Rocket Chat: Settings ‚Üí My Account ‚Üí Personal Access Tokens</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">User ID</label>
            <input type="text" class="form-control" id="user-id-rocket" placeholder="Nh·∫≠p User ID t·ª´ Rocket Chat" required>
            <div class="form-text">L·∫•y t·ª´ Rocket Chat: Settings ‚Üí My Account ‚Üí Profile</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Room ID</label>
            <input type="text" class="form-control" id="room-id" placeholder="Nh·∫≠p Room ID" required>
            <div class="form-text">ID c·ªßa channel/group mu·ªën g·ª≠i th√¥ng b√°o</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Room Name (t√πy ch·ªçn)</label>
            <input type="text" class="form-control" id="room-name" placeholder="T√™n room ƒë·ªÉ hi·ªÉn th·ªã">
          </div>
          
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">L∆∞u c·∫•u h√¨nh</button>
            <button type="button" class="btn btn-info" id="load-channels-btn">T·∫£i danh s√°ch Channels</button>
          </div>
        </form>
        
        <div id="config-result" class="mt-3"></div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Test k·∫øt n·ªëi</h5>
      </div>
      <div class="card-body">
        <form id="test-connection-form">
          <div class="mb-3">
            <label class="form-label">Auth Token (test)</label>
            <input type="password" class="form-control" id="test-auth-token" placeholder="Nh·∫≠p Auth Token ƒë·ªÉ test">
          </div>
          
          <div class="mb-3">
            <label class="form-label">User ID (test)</label>
            <input type="text" class="form-control" id="test-user-id" placeholder="Nh·∫≠p User ID ƒë·ªÉ test">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Room ID (test)</label>
            <input type="text" class="form-control" id="test-room-id" placeholder="Nh·∫≠p Room ID ƒë·ªÉ test">
          </div>
          
          <button type="submit" class="btn btn-success">Test k·∫øt n·ªëi</button>
        </form>
        
        <div id="test-result" class="mt-3"></div>
      </div>
    </div>
    
 
    
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="card-title mb-0">G·ª≠i th√¥ng b√°o t√πy ch·ªânh</h5>
      </div>
      <div class="card-body">
        <form id="send-notification-form">
          <div class="mb-3">
            <label class="form-label">Ti√™u ƒë·ªÅ</label>
            <input type="text" class="form-control" id="notification-title" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ th√¥ng b√°o" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">N·ªôi dung</label>
            <textarea class="form-control" id="notification-text" rows="3" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o" required></textarea>
          </div>
          
          <div class="mb-3">
            <label class="form-label">M√†u s·∫Øc</label>
            <select class="form-select" id="notification-color">
              <option value="good">Xanh l√° (Th√†nh c√¥ng)</option>
              <option value="warning">V√†ng (C·∫£nh b√°o)</option>
              <option value="danger">ƒê·ªè (L·ªói)</option>
              <option value="info">Xanh d∆∞∆°ng (Th√¥ng tin)</option>
            </select>
          </div>
          
          <button type="submit" class="btn btn-primary">G·ª≠i th√¥ng b√°o</button>
        </form>
        
        <div id="notification-result" class="mt-3"></div>
      </div>
    </div>
    
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Th√¥ng b√°o t√†i kho·∫£n</h5>
      </div>
      <div class="card-body">
        <form id="account-notification-form">
          <div class="mb-3">
            <label class="form-label">S·ªë ng√†y c·∫£nh b√°o tr∆∞·ªõc</label>
            <select class="form-select" id="warning-days">
              <option value="1">1 ng√†y</option>
              <option value="3">3 ng√†y</option>
              <option value="7" selected>7 ng√†y</option>
              <option value="14">14 ng√†y</option>
              <option value="30">30 ng√†y</option>
            </select>
            <div class="form-text">G·ª≠i th√¥ng b√°o cho t√†i kho·∫£n s·∫Øp h·∫øt h·∫°n trong s·ªë ng√†y n√†y</div>
          </div>
          
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-info">G·ª≠i th√¥ng b√°o t√†i kho·∫£n s·∫Øp h·∫øt h·∫°n</button>
            <button type="button" class="btn btn-success" id="send-daily-summary-btn">G·ª≠i b√°o c√°o t·ªïng h·ª£p h√†ng ng√†y</button>
          </div>
        </form>
        
        <div id="account-notification-result" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal hi·ªÉn th·ªã danh s√°ch channels -->
<div class="modal fade" id="channelsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Danh s√°ch Channels & Groups</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="channelsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="channels-tab" data-bs-toggle="tab" data-bs-target="#channels" type="button" role="tab">
              Channels
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab">
              Groups
            </button>
          </li>
        </ul>
        
        <div class="tab-content mt-3" id="channelsTabContent">
          <div class="tab-pane fade show active" id="channels" role="tabpanel">
            <div id="channels-list"></div>
          </div>
          <div class="tab-pane fade" id="groups" role="tabpanel">
            <div id="groups-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Load config khi trang load
document.addEventListener('DOMContentLoaded', function() {
  loadConfig();
});

function loadConfig() {
  console.log('üîÑ Loading Rocket Chat config...');
  fetch('/api/rocket-chat/config')
    .then(response => response.json())
    .then(data => {
      console.log('üì° API Response:', data);
      
      if (data.status === 'not_found') {
        console.log('‚ùå Ch∆∞a c√≥ c·∫•u h√¨nh Rocket Chat');
        return;
      }
      
      if (data.id) {
        console.log('‚úÖ C√≥ config, ƒëi·ªÅn v√†o form');
        console.log('   Auth Token:', data.auth_token ? data.auth_token.substring(0, 20) + '...' : 'N/A');
        console.log('   User ID Rocket:', data.user_id_rocket || 'N/A');
        console.log('   Room ID:', data.room_id || 'N/A');
        console.log('   Room Name:', data.room_name || 'N/A');
        
        // C√≥ config, ƒëi·ªÅn v√†o form
        document.getElementById('auth-token').value = data.auth_token || '';
        document.getElementById('user-id-rocket').value = data.user_id_rocket || '';
        document.getElementById('room-id').value = data.room_id || '';
        document.getElementById('room-name').value = data.room_name || '';
        
        // Hi·ªÉn th·ªã th√¥ng tin c·∫•u h√¨nh hi·ªán t·∫°i
        const configInfo = `
          <div class="alert alert-info mt-3">
            <h6>üìã C·∫•u h√¨nh hi·ªán t·∫°i:</h6>
            <ul class="mb-0">
              <li><strong>Auth Token:</strong> ${data.auth_token ? data.auth_token.substring(0, 20) + '...' : 'Ch∆∞a c·∫•u h√¨nh'}</li>
              <li><strong>User ID Rocket:</strong> ${data.user_id_rocket || 'Ch∆∞a c·∫•u h√¨nh'}</li>
              <li><strong>Room ID:</strong> ${data.room_id || 'Ch∆∞a c·∫•u h√¨nh'}</li>
              <li><strong>Room Name:</strong> ${data.room_name || 'Ch∆∞a c·∫•u h√¨nh'}</li>
            </ul>
          </div>
        `;
        document.getElementById('config-result').innerHTML = configInfo;
      }
    })
    .catch(error => {
      console.error('‚ùå Error loading config:', error);
    });
}

// Form c·∫•u h√¨nh
const rocketChatConfigForm = document.getElementById('rocket-chat-config-form');
if (rocketChatConfigForm) {
  rocketChatConfigForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const authToken = document.getElementById('auth-token').value;
    const userIdRocket = document.getElementById('user-id-rocket').value;
    const roomId = document.getElementById('room-id').value;
    const roomName = document.getElementById('room-name').value;
    
    fetch('/api/rocket-chat/config', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        auth_token: authToken,
        user_id_rocket: userIdRocket,
        room_id: roomId,
        room_name: roomName
      })
    })
    .then(response => response.json())
    .then(data => {
      const resultDiv = document.getElementById('config-result');
      if (data.status === 'success') {
        resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
      }
    })
    .catch(error => {
      console.error('Error saving config:', error);
      document.getElementById('config-result').innerHTML = '<div class="alert alert-danger">L·ªói khi l∆∞u c·∫•u h√¨nh</div>';
    });
  });
}

// Load channels
const loadChannelsBtn = document.getElementById('load-channels-btn');
if (loadChannelsBtn) {
  loadChannelsBtn.addEventListener('click', function() {
    const authToken = document.getElementById('auth-token').value;
    const userIdRocket = document.getElementById('user-id-rocket').value;
    
    if (!authToken || !userIdRocket) {
      alert('Vui l√≤ng nh·∫≠p Auth Token v√† User ID tr∆∞·ªõc');
      return;
    }
    
    const params = new URLSearchParams({
      auth_token: authToken,
      user_id_rocket: userIdRocket
    });
    
    fetch('/api/rocket-chat/channels?' + params)
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          displayChannels(data.channels, data.groups);
        } else {
          alert('L·ªói: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error loading channels:', error);
        alert('L·ªói khi t·∫£i danh s√°ch channels');
      });
  });
}

function displayChannels(channels, groups) {
  // Hi·ªÉn th·ªã channels
  let channelsHtml = '<div class="list-group">';
  channels.forEach(channel => {
    channelsHtml += `
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>${channel.name}</strong>
            <br><small class="text-muted">ID: ${channel._id}</small>
          </div>
          <button class="btn btn-sm btn-outline-primary" onclick="selectRoom('${channel._id}', '${channel.name}')">
            Ch·ªçn
          </button>
        </div>
      </div>
    `;
  });
  channelsHtml += '</div>';
  document.getElementById('channels-list').innerHTML = channelsHtml;
  
  // Hi·ªÉn th·ªã groups
  let groupsHtml = '<div class="list-group">';
  groups.forEach(group => {
    groupsHtml += `
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>${group.name}</strong>
            <br><small class="text-muted">ID: ${group._id}</small>
          </div>
          <button class="btn btn-sm btn-outline-primary" onclick="selectRoom('${group._id}', '${group.name}')">
            Ch·ªçn
          </button>
        </div>
      </div>
    `;
  });
  groupsHtml += '</div>';
  document.getElementById('groups-list').innerHTML = groupsHtml;
  
  // Hi·ªÉn th·ªã modal
  const modal = new bootstrap.Modal(document.getElementById('channelsModal'));
  modal.show();
}

function selectRoom(roomId, roomName) {
  document.getElementById('room-id').value = roomId;
  document.getElementById('room-name').value = roomName;
  
  // ƒê√≥ng modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('channelsModal'));
  modal.hide();
}

// Test connection
const testConnectionForm = document.getElementById('test-connection-form');
if (testConnectionForm) {
  testConnectionForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const authToken = document.getElementById('test-auth-token').value;
    const userId = document.getElementById('test-user-id').value;
    const roomId = document.getElementById('test-room-id').value;
    
    fetch('/api/rocket-chat/test', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        auth_token: authToken,
        user_id_rocket: userId,
        room_id: roomId
      })
    })
    .then(response => response.json())
    .then(data => {
      const resultDiv = document.getElementById('test-result');
      if (data.status === 'success') {
        resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
      }
    })
    .catch(error => {
      console.error('Error testing connection:', error);
      document.getElementById('test-result').innerHTML = '<div class="alert alert-danger">L·ªói khi test k·∫øt n·ªëi</div>';
    });
  });
}

// Send notification
const sendNotificationForm = document.getElementById('send-notification-form');
if (sendNotificationForm) {
  sendNotificationForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const title = document.getElementById('notification-title').value;
    const text = document.getElementById('notification-text').value;
    const color = document.getElementById('notification-color').value;
    
    fetch('/api/rocket-chat/send-notification', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        title: title,
        text: text,
        color: color
      })
    })
    .then(response => response.json())
    .then(data => {
      const resultDiv = document.getElementById('notification-result');
      if (data.status === 'success') {
        resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
      }
    })
    .catch(error => {
      console.error('Error sending notification:', error);
      document.getElementById('notification-result').innerHTML = '<div class="alert alert-danger">L·ªói khi g·ª≠i th√¥ng b√°o</div>';
    });
  });
}

// Send account notification
const accountNotificationForm = document.getElementById('account-notification-form');
if (accountNotificationForm) {
  accountNotificationForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const warningDays = parseInt(document.getElementById('warning-days').value);
    console.log('üîÑ Sending account notification, warning_days:', warningDays);
    
    fetch('/api/rocket-chat/send-account-notification', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        warning_days: warningDays
      })
    })
    .then(response => {
      console.log('üì° Response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('üì° Response data:', data);
      const resultDiv = document.getElementById('account-notification-result');
      if (data.status === 'success') {
        resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        console.log('‚úÖ Account notification sent successfully');
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
        console.log('‚ùå Account notification failed:', data.error);
      }
    })
    .catch(error => {
      console.error('‚ùå Error sending account notification:', error);
      document.getElementById('account-notification-result').innerHTML = '<div class="alert alert-danger">L·ªói khi g·ª≠i th√¥ng b√°o t√†i kho·∫£n</div>';
    });
  });
}

// Send daily summary
const sendDailySummaryBtn = document.getElementById('send-daily-summary-btn');
if (sendDailySummaryBtn) {
  sendDailySummaryBtn.addEventListener('click', function() {
    console.log('üîÑ Sending daily summary...');
    
    fetch('/api/rocket-chat/send-daily-summary', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      console.log('üì° Response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('üì° Response data:', data);
      const resultDiv = document.getElementById('account-notification-result');
      if (data.status === 'success') {
        resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        console.log('‚úÖ Daily summary sent successfully');
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
        console.log('‚ùå Daily summary failed:', data.error);
      }
    })
    .catch(error => {
      console.error('‚ùå Error sending daily summary:', error);
      document.getElementById('account-notification-result').innerHTML = '<div class="alert alert-danger">L·ªói khi g·ª≠i b√°o c√°o h√†ng ng√†y</div>';
    });
  });
}
</script>
{% endblock %} 