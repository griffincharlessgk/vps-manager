{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">Qu·∫£n l√Ω ZingProxy</h2>

<!-- Form th√™m t√†i kho·∫£n ZingProxy -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Th√™m t√†i kho·∫£n ZingProxy</h5>
  </div>
  <div class="card-body">
    <form id="zingproxy-login-form" class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Access Token</label>
        <input type="password" class="form-control" id="zingproxy-access-token" placeholder="Nh·∫≠p access token c·ªßa b·∫°n" required>
        <div class="form-text">Access token s·∫Ω ƒë∆∞·ª£c m√£ h√≥a v√† l∆∞u an to√†n. Email s·∫Ω ƒë∆∞·ª£c l·∫•y t·ª± ƒë·ªông t·ª´ API.</div>
      </div>
      <div class="col-md-2">
        <label class="form-label">T·∫ßn su·∫•t c·∫≠p nh·∫≠t</label>
        <select class="form-select" id="zingproxy-update-frequency">
          <option value="1">1 ng√†y</option>
          <option value="3">3 ng√†y</option>
          <option value="7">7 ng√†y</option>
          <option value="30">30 ng√†y</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-save"></i> L∆∞u t√†i kho·∫£n
        </button>
      </div>
    </form>
    <div id="zingproxy-login-result"></div>
  </div>
</div>

<!-- Danh s√°ch t√†i kho·∫£n ZingProxy -->
<div class="card mb-4">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">T√†i kho·∫£n ZingProxy</h5>
      <div>
        <button class="btn btn-success me-2" id="update-all-accounts-btn">
          <i class="fas fa-sync"></i> C·∫≠p nh·∫≠t t·∫•t c·∫£ t√†i kho·∫£n
        </button>
        <button class="btn btn-info" id="refresh-accounts-btn">
          <i class="fas fa-refresh"></i> L√†m m·ªõi
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div id="zingproxy-accounts-list"></div>
  </div>
</div>

<!-- Danh s√°ch proxy -->
<div class="card mb-4">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">Danh s√°ch Proxy</h5>
      <div>
        <button class="btn btn-success me-2" id="update-all-proxies-btn">
          <i class="fas fa-sync"></i> C·∫≠p nh·∫≠t t·∫•t c·∫£ proxy
        </button>
        <button class="btn btn-info" id="refresh-proxies-btn">
          <i class="fas fa-refresh"></i> L√†m m·ªõi
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div id="zingproxy-proxies-list"></div>
  </div>
</div>

<script>
let currentAccountId = null;

// ƒêƒÉng nh·∫≠p/l∆∞u t√†i kho·∫£n
document.getElementById('zingproxy-login-form').onsubmit = async function(e) {
  e.preventDefault();
  const accessToken = document.getElementById('zingproxy-access-token').value;
  const updateFrequency = document.getElementById('zingproxy-update-frequency').value;
  const resultDiv = document.getElementById('zingproxy-login-result');
  
  if (!accessToken) {
    resultDiv.innerHTML = '<div class="alert alert-danger">Vui l√≤ng nh·∫≠p access token!</div>';
    return;
  }
  
  resultDiv.innerHTML = '<div class="alert alert-info">ƒêang x·ª≠ l√Ω...</div>';
  
  try {
    const res = await fetch('/api/zingproxy-login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        access_token: accessToken, 
        update_frequency: updateFrequency
      })
    });
    const json = await res.json();
    
    if(json.status === 'success') {
      resultDiv.innerHTML = '<div class="alert alert-success">‚úÖ ƒê√£ l∆∞u t√†i kho·∫£n th√†nh c√¥ng!</div>';
      this.reset();
      loadAccounts();
      loadAllProxies();
    } else {
      resultDiv.innerHTML = `<div class='alert alert-danger'>‚ùå ${json.error}</div>`;
    }
  } catch (error) {
    resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå L·ªói k·∫øt n·ªëi!</div>';
  }
};

// Load danh s√°ch t√†i kho·∫£n
async function loadAccounts() {
  try {
    const res = await fetch('/api/zingproxy-accounts');
    const json = await res.json();
    const listDiv = document.getElementById('zingproxy-accounts-list');
    
    if(json.status === 'success') {
      if(json.accounts.length === 0) {
        listDiv.innerHTML = '<div class="alert alert-info">üìù Ch∆∞a c√≥ t√†i kho·∫£n n√†o. H√£y th√™m t√†i kho·∫£n ƒë·∫ßu ti√™n!</div>';
        return;
      }
      
      let html = `
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Email</th>
                <th>S·ªë d∆∞</th>
                <th>Ng√†y t·∫°o</th>
                <th>C·∫≠p nh·∫≠t cu·ªëi</th>
                <th>T·∫ßn su·∫•t</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      json.accounts.forEach(acc => {
        const lastUpdated = acc.last_updated ? new Date(acc.last_updated).toLocaleString('vi-VN') : 'Ch∆∞a c·∫≠p nh·∫≠t';
        const createdDate = acc.created_at ? new Date(acc.created_at).toLocaleDateString('vi-VN') : 'N/A';
        const statusClass = acc.last_updated ? 'success' : 'warning';
        const statusText = acc.last_updated ? 'Ho·∫°t ƒë·ªông' : 'Ch∆∞a c·∫≠p nh·∫≠t';
        
        html += `
          <tr>
            <td><strong>${acc.email}</strong></td>
            <td><span class="badge bg-success fs-6">$${acc.balance || 0}</span></td>
            <td>${createdDate}</td>
            <td>${lastUpdated}</td>
            <td><span class="badge bg-info">${acc.update_frequency} ng√†y</span></td>
            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            <td>
              <div class="btn-group" role="group">
                <button class='btn btn-sm btn-info me-1' onclick='updateAccount(${acc.id})' title="C·∫≠p nh·∫≠t th√¥ng tin t√†i kho·∫£n">
                  <i class="fas fa-sync"></i>
                </button>
                <button class='btn btn-sm btn-warning me-1' onclick='updateProxies(${acc.id})' title="C·∫≠p nh·∫≠t proxy">
                  <i class="fas fa-list"></i>
                </button>
                <button class='btn btn-sm btn-danger' onclick='deleteAccount(${acc.id})' title="X√≥a t√†i kho·∫£n">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      listDiv.innerHTML = html;
    } else {
      listDiv.innerHTML = `<div class='alert alert-danger'>‚ùå ${json.error}</div>`;
    }
  } catch (error) {
    document.getElementById('zingproxy-accounts-list').innerHTML = '<div class="alert alert-danger">‚ùå L·ªói k·∫øt n·ªëi!</div>';
  }
}

// Load t·∫•t c·∫£ proxy t·ª´ t·∫•t c·∫£ t√†i kho·∫£n
async function loadAllProxies() {
  try {
    const res = await fetch('/api/zingproxy-accounts');
    const json = await res.json();
    
    if(json.status === 'success' && json.accounts.length > 0) {
      let allProxies = [];
      
      // L·∫•y proxy t·ª´ t·∫•t c·∫£ t√†i kho·∫£n
      for(const acc of json.accounts) {
        const proxyRes = await fetch(`/api/zingproxy-proxies/${acc.id}`);
        const proxyJson = await proxyRes.json();
        
        if(proxyJson.status === 'success') {
          allProxies = allProxies.concat(proxyJson.proxies);
        }
      }
      
      displayProxies(allProxies);
    } else {
      document.getElementById('zingproxy-proxies-list').innerHTML = '<div class="alert alert-info">üìù Ch∆∞a c√≥ proxy n√†o.</div>';
    }
  } catch (error) {
    document.getElementById('zingproxy-proxies-list').innerHTML = '<div class="alert alert-danger">‚ùå L·ªói k·∫øt n·ªëi!</div>';
  }
}

// Hi·ªÉn th·ªã danh s√°ch proxy
function displayProxies(proxies) {
  const listDiv = document.getElementById('zingproxy-proxies-list');
  
  if(proxies.length === 0) {
    listDiv.innerHTML = '<div class="alert alert-info">üìù Ch∆∞a c√≥ proxy n√†o.</div>';
    return;
  }
  
  let html = `
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>IP</th>
            <th>Port HTTP</th>
            <th>Port SOCKS5</th>
            <th>Username</th>
            <th>Password</th>
            <th>Tr·∫°ng th√°i</th>
            <th>H·∫øt h·∫°n</th>
            <th>Type</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  proxies.forEach(proxy => {
    const statusClass = proxy.status === 'running' ? 'success' : 'warning';
    const expiryDate = proxy.expire_at ? new Date(proxy.expire_at).toLocaleDateString('vi-VN') : 'N/A';
    
    html += `
      <tr>
        <td><code>${proxy.proxy_id}</code></td>
        <td><strong>${proxy.ip || ''}</strong></td>
        <td><span class="badge bg-primary">${proxy.port || ''}</span></td>
        <td><span class="badge bg-secondary">${proxy.port_socks5 || ''}</span></td>
        <td><code>${proxy.username || ''}</code></td>
        <td><code>${proxy.password || ''}</code></td>
        <td><span class="badge bg-${statusClass}">${proxy.status || ''}</span></td>
        <td>${expiryDate}</td>
        <td><span class="badge bg-info">${proxy.type || ''}</span></td>
        <td>${proxy.note || ''}</td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  listDiv.innerHTML = html;
}

// C·∫≠p nh·∫≠t th√¥ng tin t√†i kho·∫£n
async function updateAccount(accId) {
  try {
    const res = await fetch(`/api/zingproxy-update-account/${accId}`, {method: 'POST'});
    const json = await res.json();
    
    if(json.status === 'success') {
      showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin t√†i kho·∫£n!', 'success');
      loadAccounts();
      loadAllProxies();
    } else {
      showToast(`‚ùå ${json.error}`, 'error');
    }
  } catch (error) {
    showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
  }
}

// C·∫≠p nh·∫≠t proxy cho t√†i kho·∫£n
async function updateProxies(accId) {
  try {
    const res = await fetch(`/api/zingproxy-update-proxies/${accId}`, {method: 'POST'});
    const json = await res.json();
    
    if(json.status === 'success') {
      showToast(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t ${json.count} proxy!`, 'success');
      loadAllProxies();
    } else {
      showToast(`‚ùå ${json.error}`, 'error');
    }
  } catch (error) {
    showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
  }
}

// X√≥a t√†i kho·∫£n
async function deleteAccount(accId) {
  if(!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
  
  try {
    const res = await fetch(`/api/zingproxy-delete-account/${accId}`, {method: 'DELETE'});
    const json = await res.json();
    
    if(json.status === 'success') {
      showToast('‚úÖ ƒê√£ x√≥a t√†i kho·∫£n!', 'success');
      loadAccounts();
      loadAllProxies();
    } else {
      showToast(`‚ùå ${json.error}`, 'error');
    }
  } catch (error) {
    showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
  }
}

// C·∫≠p nh·∫≠t t·∫•t c·∫£ t√†i kho·∫£n
document.getElementById('update-all-accounts-btn').onclick = async function() {
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang c·∫≠p nh·∫≠t...';
  
  try {
    const res = await fetch('/api/zingproxy-update-all-accounts', {method: 'POST'});
    const json = await res.json();
    
    if(json.status === 'success') {
      showToast(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t ${json.updated_count} t√†i kho·∫£n!`, 'success');
      loadAccounts();
      loadAllProxies();
    } else {
      showToast(`‚ùå ${json.error}`, 'error');
    }
  } catch (error) {
    showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
  } finally {
    this.disabled = false;
    this.innerHTML = '<i class="fas fa-sync"></i> C·∫≠p nh·∫≠t t·∫•t c·∫£ t√†i kho·∫£n';
  }
};

// C·∫≠p nh·∫≠t t·∫•t c·∫£ proxy
document.getElementById('update-all-proxies-btn').onclick = async function() {
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang c·∫≠p nh·∫≠t...';
  
  try {
    const res = await fetch('/api/zingproxy-update-all-proxies', {method: 'POST'});
    const json = await res.json();
    
    if(json.status === 'success') {
      showToast(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t proxy cho ${json.updated_count} t√†i kho·∫£n!`, 'success');
      loadAllProxies();
    } else {
      showToast(`‚ùå ${json.error}`, 'error');
    }
  } catch (error) {
    showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
  } finally {
    this.disabled = false;
    this.innerHTML = '<i class="fas fa-sync"></i> C·∫≠p nh·∫≠t t·∫•t c·∫£ proxy';
  }
};

// L√†m m·ªõi danh s√°ch t√†i kho·∫£n
document.getElementById('refresh-accounts-btn').onclick = function() {
  loadAccounts();
};

// L√†m m·ªõi danh s√°ch proxy
document.getElementById('refresh-proxies-btn').onclick = function() {
  loadAllProxies();
};

// Hi·ªÉn th·ªã toast notification
function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toast-container') || createToastContainer();
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
  toast.setAttribute('role', 'alert');
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();
  
  // T·ª± ƒë·ªông x√≥a toast sau khi ·∫©n
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

// T·∫°o toast container n·∫øu ch∆∞a c√≥
function createToastContainer() {
  const container = document.createElement('div');
  container.id = 'toast-container';
  container.className = 'toast-container position-fixed top-0 end-0 p-3';
  container.style.zIndex = '9999';
  document.body.appendChild(container);
  return container;
}

// Load d·ªØ li·ªáu khi trang load
document.addEventListener('DOMContentLoaded', function() {
  loadAccounts();
  loadAllProxies();
});
</script>
{% endblock %} 