{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω th√¥ng b√°o{% endblock %}

{% block content %}
<style>
.expiry-warnings-table {
    font-size: 0.9rem;
}

.expiry-warnings-table th {
    background-color: #343a40;
    color: white;
    font-weight: 600;
    border: none;
    padding: 12px 8px;
}

.expiry-warnings-table td {
    padding: 10px 8px;
    vertical-align: middle;
}

.expiry-warnings-table .table-danger {
    background-color: #f8d7da;
}

.expiry-warnings-table .table-warning {
    background-color: #fff3cd;
}

.expiry-warnings-table .table-info {
    background-color: #d1ecf1;
}

.status-badge {
    font-size: 0.8rem;
    padding: 4px 8px;
}

.stats-card {
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.loading-spinner {
    color: #007bff;
}

.no-warnings-icon {
    font-size: 3rem;
    color: #28a745;
    margin-bottom: 1rem;
}
</style>
<div class="container mt-4">
    <h2 class="mb-4">üîî Qu·∫£n l√Ω th√¥ng b√°o</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="notificationTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                ‚öôÔ∏è C√†i ƒë·∫∑t th√¥ng b√°o
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="warnings-tab" data-bs-toggle="tab" data-bs-target="#warnings" type="button" role="tab">
                ‚ö†Ô∏è C·∫£nh b√°o h·∫øt h·∫°n
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="notificationTabContent">
        <!-- C√†i ƒë·∫∑t th√¥ng b√°o -->
        <div class="tab-pane fade show active" id="settings" role="tabpanel">
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üí¨ C√†i ƒë·∫∑t RocketChat</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <strong>üìã H∆∞·ªõng d·∫´n c·∫•u h√¨nh:</strong><br>
                                1. Truy c·∫≠p <a href="/rocket-chat" target="_blank">C·∫•u h√¨nh RocketChat</a><br>
                                2. Nh·∫≠p Auth Token, User ID v√† Room ID<br>
                                3. L∆∞u c·∫•u h√¨nh ƒë·ªÉ k√≠ch ho·∫°t th√¥ng b√°o
                            </div>
                            <div class="d-flex gap-2">
                                <a href="/rocket-chat" class="btn btn-primary">‚öôÔ∏è C·∫•u h√¨nh RocketChat</a>
                                <button class="btn btn-success" onclick="testRocketChatNotification()">‚úî Test th√¥ng b√°o</button>
                                <button class="btn btn-info" onclick="testRocketChatDailySummary()">üìä Test Daily Summary</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">‚è∞ C√†i ƒë·∫∑t th·ªùi gian</h5>
                        </div>
                        <div class="card-body">
                            <form id="notify-settings-form">
                                <div class="mb-3">
                                    <label for="notify-days" class="form-label">S·ªë ng√†y c·∫£nh b√°o tr∆∞·ªõc khi h·∫øt h·∫°n</label>
                                    <input type="number" class="form-control" id="notify-days" min="1" max="30" value="3">
                                    <div class="form-text">S·ªë ng√†y tr∆∞·ªõc khi h·∫øt h·∫°n ƒë·ªÉ g·ª≠i c·∫£nh b√°o (1-30 ng√†y)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="notify-hour" class="form-label">Gi·ªù g·ª≠i th√¥ng b√°o</label>
                                    <select class="form-select" id="notify-hour">
                                        <option value="0">00:00</option>
                                        <option value="1">01:00</option>
                                        <option value="2">02:00</option>
                                        <option value="3">03:00</option>
                                        <option value="4">04:00</option>
                                        <option value="5">05:00</option>
                                        <option value="6">06:00</option>
                                        <option value="7">07:00</option>
                                        <option value="8" selected>08:00</option>
                                        <option value="9">09:00</option>
                                        <option value="10">10:00</option>
                                        <option value="11">11:00</option>
                                        <option value="12">12:00</option>
                                        <option value="13">13:00</option>
                                        <option value="14">14:00</option>
                                        <option value="15">15:00</option>
                                        <option value="16">16:00</option>
                                        <option value="17">17:00</option>
                                        <option value="18">18:00</option>
                                        <option value="19">19:00</option>
                                        <option value="20">20:00</option>
                                        <option value="21">21:00</option>
                                        <option value="22">22:00</option>
                                        <option value="23">23:00</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="notify-minute" class="form-label">Ph√∫t g·ª≠i th√¥ng b√°o</label>
                                    <select class="form-select" id="notify-minute">
                                        <option value="0" selected>00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">üíæ L∆∞u c√†i ƒë·∫∑t</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- C·∫£nh b√°o h·∫øt h·∫°n -->
        <div class="tab-pane fade" id="warnings" role="tabpanel">
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">‚ö†Ô∏è Danh s√°ch c·∫£nh b√°o h·∫øt h·∫°n</h5>
                        </div>
                        <div class="card-body">
                            <div id="expiry-warnings-container">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">ƒêang t·∫£i danh s√°ch c·∫£nh b√°o...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load c√†i ƒë·∫∑t th√¥ng b√°o khi trang load
document.addEventListener('DOMContentLoaded', function() {
    loadNotifySettings();
    loadExpiryWarnings();
});

// Load c√†i ƒë·∫∑t th√¥ng b√°o
async function loadNotifySettings() {
    try {
        const res = await fetch('/api/notify-days');
        const data = await res.json();
        if (data.status === 'success') {
            document.getElementById('notify-days').value = data.notify_days || 3;
        }
        
        const res2 = await fetch('/api/notify-hour');
        const data2 = await res2.json();
        if (data2.status === 'success') {
            document.getElementById('notify-hour').value = data2.notify_hour || 8;
        }
        
        const res3 = await fetch('/api/notify-minute');
        const data3 = await res3.json();
        if (data3.status === 'success') {
            document.getElementById('notify-minute').value = data3.notify_minute || 0;
        }
    } catch (error) {
        console.error('L·ªói load settings:', error);
    }
}

// L∆∞u c√†i ƒë·∫∑t th√¥ng b√°o
document.getElementById('notify-settings-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const notifyDays = document.getElementById('notify-days').value;
    const notifyHour = document.getElementById('notify-hour').value;
    const notifyMinute = document.getElementById('notify-minute').value;
    
    try {
        // L∆∞u notify days
        const res1 = await fetch('/api/notify-days', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notify_days: parseInt(notifyDays)})
        });
        
        // L∆∞u notify hour
        const res2 = await fetch('/api/notify-hour', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notify_hour: parseInt(notifyHour)})
        });
        
        // L∆∞u notify minute
        const res3 = await fetch('/api/notify-minute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notify_minute: parseInt(notifyMinute)})
        });
        
        const data1 = await res1.json();
        const data2 = await res2.json();
        const data3 = await res3.json();
        
        if (data1.status === 'success' && data2.status === 'success' && data3.status === 'success') {
            alert('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t th√¥ng b√°o th√†nh c√¥ng!');
        } else {
            alert('‚ùå L·ªói khi l∆∞u c√†i ƒë·∫∑t th√¥ng b√°o!');
        }
    } catch (error) {
        console.error('L·ªói l∆∞u settings:', error);
        alert('‚ùå L·ªói khi l∆∞u c√†i ƒë·∫∑t th√¥ng b√°o!');
    }
});

// Test RocketChat notification
async function testRocketChatNotification() {
    try {
        const res = await fetch('/api/test-rocketchat-notification', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await res.json();
        
        if (data.status === 'success') {
            alert('‚úÖ Test th√¥ng b√°o RocketChat th√†nh c√¥ng!');
        } else {
            alert(`‚ùå Test th√¥ng b√°o RocketChat th·∫•t b·∫°i: ${data.error}`);
        }
    } catch (error) {
        console.error('L·ªói test notification:', error);
        alert('‚ùå L·ªói khi test th√¥ng b√°o RocketChat!');
    }
}

// Test RocketChat daily summary
async function testRocketChatDailySummary() {
    try {
        const res = await fetch('/api/test-rocketchat-daily-summary', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await res.json();
        
        if (data.status === 'success') {
            alert('‚úÖ Test Daily Summary RocketChat th√†nh c√¥ng!');
        } else {
            alert(`‚ùå Test Daily Summary RocketChat th·∫•t b·∫°i: ${data.error}`);
        }
    } catch (error) {
        console.error('L·ªói test daily summary:', error);
        alert('‚ùå L·ªói khi test Daily Summary RocketChat!');
    }
}

// Load danh s√°ch c·∫£nh b√°o h·∫øt h·∫°n
async function loadExpiryWarnings() {
    try {
        const res = await fetch('/api/expiry-warnings');
        const data = await res.json();
        
        const container = document.getElementById('expiry-warnings-container');
        
        if (data.status === 'success' && data.warnings && data.warnings.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-striped table-hover expiry-warnings-table">';
            html += '<thead class="table-dark"><tr><th>Lo·∫°i</th><th>T√™n</th><th>Service</th><th>IP/Th√¥ng tin</th><th>Ng√†y h·∫øt h·∫°n</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody>';
            
            data.warnings.forEach(warning => {
                const daysLeft = warning.days_left;
                let statusClass = '';
                let statusText = '';
                let statusIcon = '';
                
                if (daysLeft < 0) {
                    statusClass = 'table-danger';
                    statusIcon = '‚ùå';
                    statusText = `ƒê√£ qu√° h·∫°n ${Math.abs(daysLeft)} ng√†y`;
                } else if (daysLeft === 0) {
                    statusClass = 'table-warning';
                    statusIcon = 'üö®';
                    statusText = 'H·∫æT H·∫†N H√îM NAY!';
                } else if (daysLeft <= 3) {
                    statusClass = 'table-info';
                    statusIcon = 'üî∂';
                    statusText = `C√≤n ${daysLeft} ng√†y`;
                } else {
                    statusClass = '';
                    statusIcon = 'üìÖ';
                    statusText = `C√≤n ${daysLeft} ng√†y`;
                }
                
                // Format ng√†y h·∫øt h·∫°n
                const expiryDate = warning.expiry ? new Date(warning.expiry).toLocaleDateString('vi-VN') : 'N/A';
                
                // Format IP/Th√¥ng tin
                const ipInfo = warning.ip && warning.ip !== 'N/A' ? warning.ip : '-';
                
                html += `<tr class="${statusClass}">
                    <td><span class="badge bg-primary">${warning.item_type}</span></td>
                    <td><strong>${warning.name}</strong></td>
                    <td><span class="text-muted">${warning.service}</span></td>
                    <td><code>${ipInfo}</code></td>
                    <td>${expiryDate}</td>
                    <td><span class="badge status-badge bg-${daysLeft < 0 ? 'danger' : daysLeft === 0 ? 'warning' : daysLeft <= 3 ? 'info' : 'secondary'}">${statusIcon} ${statusText}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // Th√™m th·ªëng k√™
            const expiredCount = data.warnings.filter(w => w.days_left < 0).length;
            const todayCount = data.warnings.filter(w => w.days_left === 0).length;
            const warningCount = data.warnings.filter(w => w.days_left > 0 && w.days_left <= 3).length;
            
            html += `<div class="row mt-3">
                <div class="col-md-3">
                    <div class="card bg-danger text-white stats-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">${expiredCount}</h5>
                            <p class="card-text">ƒê√£ h·∫øt h·∫°n</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white stats-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">${todayCount}</h5>
                            <p class="card-text">H·∫øt h·∫°n h√¥m nay</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white stats-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">${warningCount}</h5>
                            <p class="card-text">C·∫£nh b√°o s·ªõm</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-secondary text-white stats-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">${data.warnings.length}</h5>
                            <p class="card-text">T·ªïng c·ªông</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="alert alert-success text-center"><i class="fas fa-check-circle no-warnings-icon"></i><br>‚úÖ Kh√¥ng c√≥ c·∫£nh b√°o h·∫øt h·∫°n n√†o!</div>';
        }
    } catch (error) {
        console.error('L·ªói load expiry warnings:', error);
        document.getElementById('expiry-warnings-container').innerHTML = 
            '<div class="alert alert-danger">‚ùå L·ªói khi t·∫£i danh s√°ch c·∫£nh b√°o h·∫øt h·∫°n!</div>';
    }
}
</script>
{% endblock %}