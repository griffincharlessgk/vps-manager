{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω th√¥ng b√°o{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üîî Qu·∫£n l√Ω th√¥ng b√°o</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="notificationTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                ‚öôÔ∏è C√†i ƒë·∫∑t th√¥ng b√°o
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="warnings-tab" data-bs-toggle="tab" data-bs-target="#warnings" type="button" role="tab">
                ‚ö†Ô∏è C·∫£nh b√°o h·∫øt h·∫°n
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="notificationTabContent">
        <!-- C√†i ƒë·∫∑t th√¥ng b√°o -->
        <div class="tab-pane fade show active" id="settings" role="tabpanel">
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üì± C√†i ƒë·∫∑t Telegram</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="telegram-chat-id" class="form-label">Chat ID Telegram</label>
                                <input type="text" class="form-control" id="telegram-chat-id" >
                                <div class="form-text">G·ª≠i tin nh·∫Øn cho @userinfobot ƒë·ªÉ l·∫•y Chat ID</div>
                            </div>
                            <button class="btn btn-primary" onclick="saveTelegramChatId()">L∆∞u Chat ID</button>
                            <button class="btn btn-success ms-2" onclick="testNotification()">‚úî Test th√¥ng b√°o</button>
                            <button class="btn btn-info ms-2" onclick="testDailySummary()">üìä Test Daily Summary</button>
                            <!-- <button class="btn btn-warning ms-2" onclick="testTelegramSimple()">üîß Test Telegram Simple</button> -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">‚è∞ C√†i ƒë·∫∑t th·ªùi gian</h5>
                        </div>
                        <div class="card-body">
                            <form id="notify-settings-form">
                                <div class="mb-3">
                                    <label class="form-label">S·ªë ng√†y c·∫£nh b√°o tr∆∞·ªõc khi h·∫øt h·∫°n</label>
                                    <select class="form-select" id="notify-days">
                                        <option value="1">1 ng√†y</option>
                                        <option value="3">3 ng√†y</option>
                                        <option value="7">7 ng√†y</option>
                                        <option value="14">14 ng√†y</option>
                                        <option value="30">30 ng√†y</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Gi·ªù g·ª≠i th√¥ng b√°o</label>
                                    <select class="form-select" id="notify-hour">
                                        <option value="6">06:00</option>
                                        <option value="7">07:00</option>
                                        <option value="8">08:00</option>
                                        <option value="9">09:00</option>
                                        <option value="10">10:00</option>
                                        <option value="11">11:00</option>
                                        <option value="12">12:00</option>
                                        <option value="13">13:00</option>
                                        <option value="14">14:00</option>
                                        <option value="15">15:00</option>
                                        <option value="16">16:00</option>
                                        <option value="17">17:00</option>
                                        <option value="18">18:00</option>
                                        <option value="19">19:00</option>
                                        <option value="20">20:00</option>
                                        <option value="21">21:00</option>
                                        <option value="22">22:00</option>
                                        <option value="23">23:00</option>
                                        <option value="0">00:00</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">L∆∞u c√†i ƒë·∫∑t</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Th·ªùi gian hi·ªán t·∫°i -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card text-bg-info">
                        <div class="card-header">
                            <h5 class="card-title mb-0">‚è∞ Th·ªùi gian hi·ªán t·∫°i</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text" id="current-time-display">ƒêang t·∫£i...</p>
                            <small class="text-light" id="next-notify-display">ƒêang t·∫£i...</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">‚è≥ Th·ªùi gian ƒë·∫øn l·∫ßn g·ª≠i th√¥ng b√°o ti·∫øp theo</h5>
                        </div>
                        <div class="card-body">
                            <div id="notify-countdown" class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- C·∫£nh b√°o h·∫øt h·∫°n -->
        <div class="tab-pane fade" id="warnings" role="tabpanel">
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">‚ö†Ô∏è Danh s√°ch c·∫£nh b√°o h·∫øt h·∫°n</h5>
                            <div>
                                <button class="btn btn-success me-2" onclick="sendAllNotifications()">
                                    üì§ G·ª≠i t·∫•t c·∫£ c·∫£nh b√°o
                                </button>
                                <button class="btn btn-primary" onclick="loadExpiryWarnings()">
                                    üîÑ L√†m m·ªõi
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="expiry-warnings-list">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load settings khi trang load
document.addEventListener('DOMContentLoaded', function() {
    loadNotifySettings();
    loadTelegramSettings();
    loadNotifyCountdown();
    loadExpiryWarnings();
});

// Load c√†i ƒë·∫∑t th√¥ng b√°o
async function loadNotifySettings() {
    try {
        const res = await fetch('/api/notify-days');
        const data = await res.json();
        if (data.status === 'success') {
            document.getElementById('notify-days').value = data.notify_days || 3;
        }
        
        const res2 = await fetch('/api/notify-hour');
        const data2 = await res2.json();
        if (data2.status === 'success') {
            document.getElementById('notify-hour').value = data2.notify_hour || 8;
        }
    } catch (error) {
        console.error('L·ªói load settings:', error);
    }
}

// Load c√†i ƒë·∫∑t Telegram
async function loadTelegramSettings() {
    try {
        const res = await fetch('/api/telegram-chat-id');
        const data = await res.json();
        if (data.status === 'success') {
            document.getElementById('telegram-chat-id').value = data.telegram_chat_id || '';
        }
    } catch (error) {
        console.error('L·ªói load Telegram settings:', error);
    }
}

// L∆∞u c√†i ƒë·∫∑t th√¥ng b√°o
document.getElementById('notify-settings-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const notifyDays = parseInt(document.getElementById('notify-days').value);
    const notifyHour = parseInt(document.getElementById('notify-hour').value);
    
    try {
        // L∆∞u notify days
        const res1 = await fetch('/api/notify-days', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notify_days: notifyDays})
        });
        
        // L∆∞u notify hour
        const res2 = await fetch('/api/notify-hour', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notify_hour: notifyHour})
        });
        
        const data1 = await res1.json();
        const data2 = await res2.json();
        
        if (data1.status === 'success' && data2.status === 'success') {
            alert('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t th√¥ng b√°o!');
            loadNotifyCountdown(); // Reload countdown
        } else {
            alert('‚ùå L·ªói l∆∞u c√†i ƒë·∫∑t!');
        }
    } catch (error) {
        console.error('L·ªói:', error);
        alert('‚ùå L·ªói l∆∞u c√†i ƒë·∫∑t!');
    }
});

// L∆∞u Chat ID Telegram
async function saveTelegramChatId() {
    const chatId = document.getElementById('telegram-chat-id').value.trim();
    
    try {
        const res = await fetch('/api/telegram-chat-id', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({telegram_chat_id: chatId})
        });
        
        const data = await res.json();
        if (data.status === 'success') {
            alert('‚úÖ ƒê√£ l∆∞u Chat ID Telegram!');
        } else {
            alert('‚ùå L·ªói l∆∞u Chat ID!');
        }
    } catch (error) {
        console.error('L·ªói:', error);
        alert('‚ùå L·ªói l∆∞u Chat ID!');
    }
}

// Test th√¥ng b√°o
async function testNotification() {
    try {
        const res = await fetch('/api/test-notification', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        
        const data = await res.json();
        if (data.status === 'success') {
            alert('‚úÖ ƒê√£ g·ª≠i th√¥ng b√°o test!');
        } else {
            alert('‚ùå L·ªói g·ª≠i th√¥ng b√°o: ' + data.error);
        }
    } catch (error) {
        console.error('L·ªói:', error);
        alert('‚ùå L·ªói g·ª≠i th√¥ng b√°o!');
    }
}

// Test Daily Summary
async function testDailySummary() {
    try {
        const res = await fetch('/api/test-daily-summary', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        
        const data = await res.json();
        if (data.status === 'success') {
            alert('‚úÖ ƒê√£ g·ª≠i th√¥ng b√°o Daily Summary!');
        } else {
            alert('‚ùå L·ªói g·ª≠i th√¥ng b√°o Daily Summary: ' + data.error);
        }
    } catch (error) {
        console.error('L·ªói:', error);
        alert('‚ùå L·ªói g·ª≠i th√¥ng b√°o Daily Summary!');
    }
}

// Test Telegram Simple
// async function testTelegramSimple() {
//     try {
//         const res = await fetch('/api/test-telegram-simple', {
//             method: 'POST',
//             headers: {'Content-Type': 'application/json'},
//             body: JSON.stringify({})
//         });
        
//         const data = await res.json();
//         if (data.status === 'success') {
//             alert('‚úÖ ƒê√£ g·ª≠i test message ƒë∆°n gi·∫£n!');
//         } else {
//             alert('‚ùå L·ªói g·ª≠i test message ƒë∆°n gi·∫£n: ' + data.error);
//         }
//     } catch (error) {
//         console.error('L·ªói:', error);
//         alert('‚ùå L·ªói g·ª≠i test message ƒë∆°n gi·∫£n!');
//     }
// }

// Load countdown
async function loadNotifyCountdown() {
    try {
        const res = await fetch('/api/next-notify-countdown');
        const data = await res.json();
        
        if (data.status === 'success') {
            let seconds = data.next_notify_in_seconds;
            
            function updateCountdown() {
                if (seconds < 0) {
                    document.getElementById('notify-countdown').innerHTML = 
                        '<div class="alert alert-info">üîÑ ƒêang c·∫≠p nh·∫≠t...</div>';
                    return;
                }
                
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                document.getElementById('notify-countdown').innerHTML = `
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-primary">${days}</h3>
                                <small>Ng√†y</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-success">${hours}</h3>
                                <small>Gi·ªù</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-warning">${minutes}</h3>
                                <small>Ph√∫t</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-danger">${secs}</h3>
                                <small>Gi√¢y</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">Th√¥ng b√°o ti·∫øp theo l√∫c ${data.notify_hour}:00</small>
                    </div>
                `;
                
                seconds--;
                setTimeout(updateCountdown, 1000);
            }
            
            updateCountdown();
        }
    } catch (error) {
        console.error('L·ªói load countdown:', error);
        document.getElementById('notify-countdown').innerHTML = 
            '<div class="alert alert-danger">‚ùå L·ªói t·∫£i countdown</div>';
    }
}

// C·∫≠p nh·∫≠t th·ªùi gian hi·ªán t·∫°i
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const dateString = now.toLocaleDateString('vi-VN', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    document.getElementById('current-time-display').textContent = `${timeString} - ${dateString}`;
}

// C·∫≠p nh·∫≠t th√¥ng tin th√¥ng b√°o
function updateNotifyInfo() {
    fetch('/api/next-notify-countdown').then(r=>r.json()).then(data=>{
        if (data.status === 'success') {
            document.getElementById('next-notify-display').textContent = data.message;
        } else {
            document.getElementById('next-notify-display').textContent = 'Kh√¥ng c√≥ th√¥ng b√°o n√†o';
        }
    }).catch(err => {
        document.getElementById('next-notify-display').textContent = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin th√¥ng b√°o';
    });
}

// Load c·∫£nh b√°o h·∫øt h·∫°n
async function loadExpiryWarnings() {
    try {
        const res = await fetch('/api/expiry-warnings');
        const data = await res.json();
        
        if (data.status === 'success') {
            const warnings = data.warnings || [];
            
            if (warnings.length === 0) {
                document.getElementById('expiry-warnings-list').innerHTML = 
                    '<div class="alert alert-success">‚úÖ Kh√¥ng c√≥ c·∫£nh b√°o h·∫øt h·∫°n n√†o!</div>';
                return;
            }
            
            let html = '<div class="row">';
            warnings.forEach(warning => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="alert alert-warning">
                            <h6 class="alert-heading">‚ö†Ô∏è ${warning}</h6>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('expiry-warnings-list').innerHTML = html;
        } else {
            document.getElementById('expiry-warnings-list').innerHTML = 
                '<div class="alert alert-danger">‚ùå L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i c·∫£nh b√°o') + '</div>';
        }
    } catch (error) {
        console.error('L·ªói load warnings:', error);
        document.getElementById('expiry-warnings-list').innerHTML = 
            '<div class="alert alert-danger">‚ùå L·ªói t·∫£i c·∫£nh b√°o</div>';
    }
}

// G·ª≠i t·∫•t c·∫£ c·∫£nh b√°o
async function sendAllNotifications() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g·ª≠i t·∫•t c·∫£ c·∫£nh b√°o h·∫øt h·∫°n kh√¥ng?')) {
        return;
    }
    try {
        const res = await fetch('/api/send-all-notifications', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await res.json();
        if (data.status === 'success') {
            alert('‚úÖ ƒê√£ g·ª≠i t·∫•t c·∫£ c·∫£nh b√°o h·∫øt h·∫°n!');
            loadExpiryWarnings(); // Reload warnings to show updated status
        } else {
            alert('‚ùå L·ªói g·ª≠i t·∫•t c·∫£ c·∫£nh b√°o: ' + data.error);
        }
    } catch (error) {
        console.error('L·ªói g·ª≠i t·∫•t c·∫£ c·∫£nh b√°o:', error);
        alert('‚ùå L·ªói g·ª≠i t·∫•t c·∫£ c·∫£nh b√°o!');
    }
}

// Kh·ªüi t·∫°o c·∫≠p nh·∫≠t th·ªùi gian
updateCurrentTime();
updateNotifyInfo();
setInterval(updateCurrentTime, 1000);
setInterval(updateNotifyInfo, 30000); // C·∫≠p nh·∫≠t th√¥ng tin th√¥ng b√°o m·ªói 30 gi√¢y
</script>
{% endblock %} 